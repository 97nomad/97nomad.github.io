<!doctype html><html lang=en><head><title>Just Nommy</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://blog.nommy.moe/style.css rel=stylesheet><link href=https://blog.nommy.moe/color/red.css rel=stylesheet><link href=https://blog.nommy.moe/color/background_blue.css rel=stylesheet><link href=https://blog.nommy.moe/font-hack.css rel=stylesheet><meta name=description><meta property=og:description><meta content="Just Nommy" property=og:title><meta content=article property=og:type><meta content=https://blog.nommy.moe/blog_ru/tasmota-tuya-perversions-ru/ property=og:url><meta content=summary_large_image name=twitter:card><meta name=twitter:description><meta content="Just Nommy" name=twitter:title><meta content=blog.nommy.moe property=twitter:domain><meta content=https://blog.nommy.moe/blog_ru/tasmota-tuya-perversions-ru/ property=twitter:url><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://blog.nommy.moe style=text-decoration:none> <div class=logo>Just Nommy</div> </a></div></div><nav class=menu><ul class=menu__inner><li><a href=https://blog.nommy.moe/about>About Me</a><li><a href=https://blog.nommy.moe/blog>Blog</a><li class=active><a href=https://blog.nommy.moe/blog_ru>Blog [Ru]</a><li><a href=https://github.com/97nomad/>GitHub</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.nommy.moe/blog_ru/tasmota-tuya-perversions-ru/>Подключаем к Home Assistant Tasmota и странные нонейм девайсы</a></h1><div class=post-meta-inline><span class=post-date> 2025-03-12 </span></div><span class=post-tags-inline> :: tags:  <a class=post-tag href=https://blog.nommy.moe/tags/hass/>#hass</a>  <a class=post-tag href=https://blog.nommy.moe/tags/ru/>#ru</a>  <a class=post-tag href=https://blog.nommy.moe/tags/smarthome/>#smarthome</a>  <a class=post-tag href=https://blog.nommy.moe/tags/tasmota/>#tasmota</a></span><div class=post-content><h1 id=problematika>Проблематика</h1><p>Однажды, один очень нехороший человек решил, что подключить весь дом (включая электроплиту) на один 2.5mm² — это очень хорошая идея.<p>Правила пожарной безопасности и автоматические предохранители же так не считали.<p>Поэтому одновременное включение бойлера и духовки вызывает полный power outage в отдельно взятой квартире, что меня неистово фрустрирует, а каждый раз бегать включать-выключать бойлер из розетки — определённо не то, чем я хотела бы заниматься.<p>Так что будем делать умный дом, чтобы рулить этим делом хотя бы со смартфона.<h1 id=zheleziaki>Железяки</h1><p>Быстрый поиск по Амазону выдал мне <code>SONOFF Zigbee Bridge 3.0 Gateway Hub, ,Soporte de Protocolo Dual,WiFi, Compatible con Dispositivos Zigbee Pro, Alexa & Google</code>, он же <code>SONOFF ZBBridge-P</code> всего за 35€. <br> Быстрогуглинг показал, что на неё есть какая-то опенсорсная прошивка. "Надо брать", — подумала я.<p>Попутно в корзину отправились <code>ZigBee Enchufe Inteligente Alexa 16A, 3680W Smart Plug con Monitor de Energía, Enchufe Temporizador con Control Remoto, Control por Voz y Funciones de Temporización, apoyo Alexa & Google Home</code> (4 штуки за 45€), позже оказавшиеся <code>Tuya TS011F</code>.<p>И ещё на сдачу была докинута <code>Garza Smart - Bombilla LED Zigbee Estándar A60, 11W (equivale a 75W de incandescencia), E27, Requiere Puente/Bridge, RGB + CCT, Intensidad regulable, Programable, Control por voz y app, Alexa/Google</code>, которая зачем-то прикидывалась <code>Tuya TZ3210</code>. <br> Чем именно является эта <code>TZ3210</code> установить так и не удалось, потому что в разных источниках пишут, что это либо выключатель, либо датчик влажности и температуры, либо всё таки RGB лампочка.<h1 id=lechim-bridzh-ot-oblaka>Лечим бридж от облака</h1><p>Так как сливать данные умного дома на какое-то непонятное облако — это моветон, первым делом нужно прошить бридж.<p>Я руководствовалась вот этой весьма подробной инструкцией <a href=https://notenoughtech.com/home-automation/tasmota-on-sonoff-zb-bridge-pro/>How to flash Tasmota on Sonoff ZB Bridge Pro</a>.<p>Единственное, что нормально не проговаривается — это пин <code>GPIO00</code>. Он должен быть подтянут к <code>GND</code> во время запуска железки, чтобы загнать её в режим прошивки через UART. <br> У меня были трудности с этим, так что успешность операции можно отследить элегантным <code>screen /dev/ttyACM0 115200</code> и посмотрев на логи запуска.<p>Я не буду описывать полный процесс прошивки, ибо он отлично описан по ссылке выше, но...<figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/how-to-get-heart-attack.jpg><figcaption class=center><p>Рис 1. Как схватить инфаркт на ровном месте</p></figcaption></figure><p>К счастью, этот баг уже давным-давно пофиксили в новой версии и кто-то просто долго не обновляла прошивку.<h1 id=nastraivaem-sekurnyi-mqtt>Настраиваем секурный MQTT</h1><p>Несмотря на то, что ESP32 уже имеет реализацию Wireguard'а, Tasmota его всё ещё не поддерживает, так что придётся выставить MQTT наружу и настроить на нём SSL, чтобы рандомные вандереры не развлекались с моими розетками.<p>Поэтому лёгким движением <code>nixos-rebuild switch ...</code> поднимаем на внешнем сервере с статическим IP Mosquitto<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>users</span><span>.</span><span style=color:#bf616a>users</span><span>.</span><span style=color:#bf616a>mosquitto</span><span>.</span><span style=color:#bf616a>extraGroups </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> [ "</span><span style=color:#a3be8c>nginx</span><span>" ]</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span><span style=color:#bf616a>services</span><span>.</span><span style=color:#bf616a>mosquitto </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>enable </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>  </span><span style=color:#d08770>listeners </span><span>= [
</span><span>    {
</span><span>      </span><span style=color:#d08770>address </span><span>= "</span><span style=color:#a3be8c>123.456.789.123</span><span>";
</span><span>      </span><span style=color:#d08770>port </span><span>= </span><span style=color:#d08770>1883</span><span>;
</span><span>      </span><span style=color:#d08770>users </span><span>= {
</span><span>        </span><span style=color:#d08770>tasmota </span><span>= {
</span><span>          </span><span style=color:#d08770>acl </span><span>= [
</span><span>            "</span><span style=color:#a3be8c>readwrite tasmota/#</span><span>"
</span><span>          ];
</span><span>          </span><span style=color:#d08770>password </span><span>= "</span><span style=color:#a3be8c>changeme</span><span>";
</span><span>        };
</span><span>      };
</span><span>      </span><span style=color:#d08770>settings </span><span>= {
</span><span>        "</span><span style=color:#a3be8c>allow_anonymous</span><span>" = </span><span style=color:#d08770>false</span><span>;
</span><span>        "</span><span style=color:#a3be8c>require_certificate</span><span>" = </span><span style=color:#d08770>false</span><span>;
</span><span>        "</span><span style=color:#a3be8c>cafile</span><span>" = "</span><span style=color:#a3be8c>/var/lib/acme/mqtt.example.com/fullchain.pem</span><span>";
</span><span>        "</span><span style=color:#a3be8c>certfile</span><span>" = "</span><span style=color:#a3be8c>/var/lib/acme/mqtt.example.com/cert.pem</span><span>";
</span><span>        "</span><span style=color:#a3be8c>keyfile</span><span>" = "</span><span style=color:#a3be8c>/var/lib/acme/mqtt.example.com/key.pem</span><span>";
</span><span>        "</span><span style=color:#a3be8c>tls_version</span><span>" = "</span><span style=color:#a3be8c>tlsv1.2</span><span>";
</span><span>      };
</span><span>    }
</span><span>    {
</span><span>      </span><span style=color:#d08770>address </span><span>= "</span><span style=color:#a3be8c>10.20.0.1</span><span>";
</span><span>      </span><span style=color:#d08770>port </span><span>= </span><span style=color:#d08770>1883</span><span>;
</span><span>      </span><span style=color:#d08770>users </span><span>= {
</span><span>        </span><span style=color:#d08770>hass </span><span>= {
</span><span>          </span><span style=color:#d08770>acl </span><span>= [
</span><span>            "</span><span style=color:#a3be8c>readwrite #</span><span>"
</span><span>          ];
</span><span>          </span><span style=color:#d08770>password </span><span>= "</span><span style=color:#a3be8c>changeme</span><span>";
</span><span>        };
</span><span>      };
</span><span>    }
</span><span>  ];
</span><span>}</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>Юзер <code>mosquitto</code> отправляется в группу <code>nginx</code> просто чтобы иметь возможность подтягивать Let's Encrypt сертификаты.<p>Также я использую систему из двух листенеров. Один защищён SSL, ограничен по самые помидоры и смотрит наружу, а второй во внутренней VPN сети спокойно даёт подсосаться к нему при помощи бриджей, но об этом чуть позже<p>Ещё стоит отметить строки <code>"require_certificate" = false;</code> и <code>"tls_version" = "tlsv1.2</code>. <br> Первая отключает авторизацию через TLS, оставляя стандартный пароль, а вторая включает шифрование трафика. <br> Без первой Tasmota не может подключться к MQTT, а без второй Mosquitto будет игнорировать все прописанные сертификаты и работать в незащищённом режиме.<p>На стороне Home Assistant'а же я настроила бридж, который будет всасывать сообщения из промежуточного MQTT и засасывать в основной. <br> Просто потому что у меня уже был настроен MQTT для локальных штук и я не хотела его трогать.<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>services</span><span>.</span><span style=color:#bf616a>mosquitto </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>enable </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>  </span><span style=color:#d08770>listeners </span><span>= [
</span><span>    </span><span style=color:#2b303b;background-color:#bf616a>...</span><span>
</span><span>  ];
</span><span>  </span><span style=color:#d08770>bridges </span><span>= {
</span><span>    "</span><span style=color:#a3be8c>external2internal</span><span>" = {
</span><span>      </span><span style=color:#d08770>addresses </span><span>= [
</span><span>        { </span><span style=color:#d08770>address </span><span>= "</span><span style=color:#a3be8c>10.20.0.1</span><span>"; </span><span style=color:#d08770>port </span><span>= </span><span style=color:#d08770>1883</span><span>; }
</span><span>      ];
</span><span>      </span><span style=color:#d08770>topics </span><span>= [
</span><span>        "</span><span style=color:#a3be8c>tasmota/# in</span><span>"
</span><span>        "</span><span style=color:#a3be8c>tasmota/cmnd/# out</span><span>"
</span><span>      ];
</span><span>      </span><span style=color:#d08770>settings </span><span>= {
</span><span>        </span><span style=color:#d08770>remote_username </span><span>= "</span><span style=color:#a3be8c>hass</span><span>";
</span><span>        </span><span style=color:#d08770>remote_password </span><span>= "</span><span style=color:#a3be8c>changeme</span><span>";
</span><span>      };
</span><span>    };
</span><span>  };
</span><span>}</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>С такой настройкой топиков я не затягиваю внутрь ничего лишнего, а наружу могут попадать только непосредственные команды для Tasmota.<p>Но это, разумеется, можно пропустить, если MQTT всего один.<p><strong>И НЕ ЗАБУДЬ ОТКРЫТЬ ПОРТ НА ФАЕРВОЛЛЕ!</strong><h1 id=podkliuchaem-bridzh-k-sekurnomu-mqtt>Подключаем бридж к секурному MQTT</h1><img class=center decoding=async loading=lazy src=https://blog.nommy.moe/blog/tasmota-tuya-perversions/tasmota-mqtt-settings.png><p>Тут и так всё очевидно и понятно, кроме пары моментов.<p>Обязательно прожимаем чекбокс <code>MQTT TLS</code>, чтобы оно вообще подключилось к нашему секурному Mosquitto.<p>И в поле <code>Full Topic</code> следует в начало дописать <code>tasmota/</code>, чтобы все сообщения аккуратно сваливать в одну группу и не прописывать в ACL каждый бридж.<p>После сопряжения устройств с бриджом (Просто нажми кнопку <code>Zigbee Permit Join</code> и включай железяку) не лишним будет проверить, действительно ли всё работает как положено и сообщения от устройств попадают в MQTT. <br> Подписываемся на <code>tasmota/#</code> и ждём, пока туда что-нибудь не посыпется.<p>Если не посыпалось, возвращаемся к началу и долго думаем, что же пошло не так.<p>Повторять до полного удовлетворения.<h1 id=izuchaem-ustroistva>Изучаем устройства</h1><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/sonoff-bridge.jpg><figcaption class=center><p>Рис. 2. SONOFF ZB Bridge-P</p></figcaption></figure><p>Вот на этом этапе и начинается Адъ и Израиль.<p>Дело в том, что Tasmota не умеет в auto discovery. Точнее умеет, но только для конечных устройств и через свой собственный плагин. <br> А так как у нас бридж, то из этого следует два факта:<ol><li>Плагин нам не нужен, сырого MQTT более чем достаточно<li>Нам никто не поможет</ol><p>Но для начала следует вооружиться консолью на самом бридже и посмотреть, что же там у нас имеется.<figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/tasmota-console.png><figcaption class=center><p>Рис. 3. Зелёный и страшный</p></figcaption></figure><p>Идём в <code>Tools > Console</code> в веб интерфейсе бриджа и начинаем тыкать всё вокруг палочкой.<p>Полный список команд лежит вот тут: <a href=https://tasmota.github.io/docs/Commands/>Tasmota Commands</a>, но нам сейчас интересна исключительно часть про <a href=https://tasmota.github.io/docs/Commands/#zigbee>Zigbee</a>.<p>А если быть точнее, то команды <code>ZbInfo</code>, <code>ZbName</code> и <code>ZbSend</code>.<h3 id=zbinfo>ZbInfo</h3><p>Вбив в терминал <code>ZbInfo</code> можно получить всю информацию о подключенных устройствах. <br> Результатом обычно получается вот такая портянка<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.524</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>7E20</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x7E20</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x7E20</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>main_light_0</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C138E23EE90340</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS0505B</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>,</span><span style=color:#d08770>242</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>O01</span><span>","</span><span style=color:#a3be8c>~01.1</span><span>","</span><span style=color:#a3be8c>L01</span><span>"],"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>1</span><span>,"</span><span style=color:#a3be8c>Dimmer</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>Hue</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Sat</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>X</span><span>":</span><span style=color:#d08770>24218</span><span>,"</span><span style=color:#a3be8c>Y</span><span>":</span><span style=color:#d08770>15601</span><span>,"</span><span style=color:#a3be8c>CT</span><span>":</span><span style=color:#d08770>499</span><span>,"</span><span style=color:#a3be8c>ColorMode</span><span>":</span><span style=color:#d08770>1</span><span>,"</span><span style=color:#a3be8c>RGB</span><span>":"</span><span style=color:#a3be8c>FFFFFF</span><span>","</span><span style=color:#a3be8c>RGBb</span><span>":"</span><span style=color:#a3be8c>FFFFFF</span><span>","</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>4</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806194</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>91</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.536</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/CD</span><span style=color:#d08770>47</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0xCD47</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0xCD47</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>aquarium_light</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C1382214F48A12</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>P01</span><span>","</span><span style=color:#a3be8c>O01</span><span>"],"</span><span style=color:#a3be8c>RMSVoltage</span><span>":</span><span style=color:#d08770>226</span><span>,"</span><span style=color:#a3be8c>ActivePower</span><span>":</span><span style=color:#d08770>10</span><span>,"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>1</span><span>,"</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>6</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806192</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>185</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.548</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>9</span><span>AD</span><span style=color:#d08770>4</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x9AD4</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x9AD4</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>boiler_switch</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C13877C8106300</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS011F</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3000_cehuw1lw</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>P01</span><span>","</span><span style=color:#a3be8c>O01</span><span>"],"</span><span style=color:#a3be8c>RMSVoltage</span><span>":</span><span style=color:#d08770>226</span><span>,"</span><span style=color:#a3be8c>ActivePower</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>73</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806125</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>98</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.563</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>3</span><span>B</span><span style=color:#d08770>30</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x3B30</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x3B30</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>main_light_1</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C1381A825F2ADE</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS0505B</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>,</span><span style=color:#d08770>242</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>~01.1</span><span>","</span><span style=color:#a3be8c>O01</span><span>","</span><span style=color:#a3be8c>L01</span><span>"],"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Dimmer</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>Hue</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Sat</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>X</span><span>":</span><span style=color:#d08770>38449</span><span>,"</span><span style=color:#a3be8c>Y</span><span>":</span><span style=color:#d08770>21476</span><span>,"</span><span style=color:#a3be8c>CT</span><span>":</span><span style=color:#d08770>283</span><span>,"</span><span style=color:#a3be8c>ColorMode</span><span>":</span><span style=color:#d08770>2</span><span>,"</span><span style=color:#a3be8c>RGB</span><span>":"</span><span style=color:#a3be8c>FF0000</span><span>","</span><span style=color:#a3be8c>RGBb</span><span>":"</span><span style=color:#a3be8c>FF0000</span><span>","</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>136</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806062</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>163</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.578</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>898</span><span>A/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x898A</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x898A</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>studio_light</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C1389F99E433CE</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS0505B</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>,</span><span style=color:#d08770>242</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>O01</span><span>","</span><span style=color:#a3be8c>~01.1</span><span>","</span><span style=color:#a3be8c>L01</span><span>"],"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Dimmer</span><span>":</span><span style=color:#d08770>42</span><span>,"</span><span style=color:#a3be8c>Hue</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Sat</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>X</span><span>":</span><span style=color:#d08770>13578</span><span>,"</span><span style=color:#a3be8c>Y</span><span>":</span><span style=color:#d08770>14165</span><span>,"</span><span style=color:#a3be8c>CT</span><span>":</span><span style=color:#d08770>283</span><span>,"</span><span style=color:#a3be8c>ColorMode</span><span>":</span><span style=color:#d08770>2</span><span>,"</span><span style=color:#a3be8c>RGB</span><span>":"</span><span style=color:#a3be8c>FF0000</span><span>","</span><span style=color:#a3be8c>RGBb</span><span>":"</span><span style=color:#a3be8c>2A0000</span><span>","</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>150</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806048</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>65</span><span>}}}
</span></code></pre><p>Если посидеть, повтыкать внимательно, то можно обнаружить:<ul><li><code>Device</code> — Короткий адрес устройства (0xAAAA). Обычно используем его, чтобы обратиться к девайсу.<li><code>ModelId</code> и <code>Manufacturer</code> — собственно, описание модели. Если посмотреть в начало статьи, то можно увидеть, что дешёвую китайскую Tuya можно встретить под разными пафосными брендами, но тут железяки палятся мгновенно.<li><code>Dimmer</code>, <code>Hue</code>, <code>Sat</code>, <code>X</code>, <code>Y</code> и все остальные железяко-специфичные параметры, которые эта самая железяка будет слать нам в MQTT.</ul><p>Последнее нам особенно пригодится, но об этом чуть позже.<h3 id=zbname>ZbName</h3><p>Сейчас самое время дать всем устройствам читаемые имена, чтобы потом не запутаться что есть что.<p><code>ZbName short_address,name</code> нам в этом поможет. Потом этот name будет ещё всплывать в каждом ивенте и можно будет с этим что-то делать, но главная цель — не запутаться.<h3 id=zbsend>ZbSend</h3><p>А теперь мы можем потыкать палочкой в девайс уже активно, ибо <code>ZbSend</code> позволяет отправить какое-нибудь сообщения и посмотреть на реакцию железки.<p>Можно, например, потыкать палочкой в умную розетку.<p><code>ZbSend {"device": "0x9AD4", "send": { "Power": "ON" }}</code> будет оную розетку включать, а <code>ZbSend {"device": "0x9AD4", "send": { "Power": "OFF" }}</code>, соответственно, выключать.<p>Как мы узнали, что нужно отправить именно <code>{ "Power": "ON" }</code> — это самый интересный вопрос.<p>И ответом на него будет "Угадали", но это немного не так.<p>Давайте посмотрим на JSON из вывода команды <code>ZbInfo 0x9AD4</code> более пристально<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x9AD4</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x9AD4</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>boiler_switch</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C13877C8106300</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS011F</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3000_cehuw1lw</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>P01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>RMSVoltage</span><span>": </span><span style=color:#d08770>226</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ActivePower</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>73</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806125</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>98
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Среди всего прочего тут можно увидеть поле <code>Power</code> со значением <code>0</code>, тобишь "Выключено". <br> А штуку с более читаемыми <code>ON</code> и <code>OFF</code> я просто в интернетах подсмотрела.<p>Если смотреть на JSON от лампочки, там больше интересного<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x7E20</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x7E20</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>main_light_0</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C138E23EE90340</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS0505B</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1</span><span>,
</span><span>        </span><span style=color:#d08770>242
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>~01.1</span><span>",
</span><span>        "</span><span style=color:#a3be8c>L01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Dimmer</span><span>": </span><span style=color:#d08770>254</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Hue</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Sat</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>X</span><span>": </span><span style=color:#d08770>24218</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Y</span><span>": </span><span style=color:#d08770>15601</span><span>,
</span><span>      "</span><span style=color:#a3be8c>CT</span><span>": </span><span style=color:#d08770>499</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ColorMode</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>RGB</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>RGBb</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>4</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806194</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>91
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Помимо <code>Power</code> мы также имеем <code>Dimmer</code>, <code>Hue</code>, <code>Sat</code>, <code>X</code>, <code>Y</code>, <code>CT</code>, <code>ColorMode</code>, <code>RGB</code> и <code>RGBb</code>. <br> Спойлер: не всё из этого можно точно так же поменять, но общее направление для копания под девайс у нас имеется.<h3 id=eshchio-odin-moment-backlog>Ещё один момент (Backlog)</h3><p>Ах, да. Тут стоить упомянуть ещё один момент.<p>Несмотря на то, что мы можем сделать <br> <code>ZbSend {"device": "0x7E20", "send": { "Hue": "128" }}</code>, <br> сделать <br> <code>ZbSend {"device": "0x7E20", "send": { "Hue": "128", "Sat": "254" }}</code> <br> мы уже не сможем, так как за один запрос можно поменять только один параметр.<p>Как быстрый воркараунд вокруг проблемы, можно использовать <a href=https://tasmota.github.io/docs/Commands/#the-power-of-backlog>Backlog</a>, встроенный язык...<p>Короче, в эту штуку можно просто несколько команд подряд передать, а потом они последовательно выполнятся. <br> И в результате наша команда будет выглядеть примерно так:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>Backlog ZbSend {"device": "0x7E20", "send": { "Hue": "128" }}; ZbSend {"device": "0x7E20", "send": { "Sat": "254" }}
</span></code></pre><p>Хорошо для быстрых хаков, но на практике получается так, что отправка двух команд — это не самый быстрый процесс и вместо этого иногда можно обнаружить "недокументированные" команды.<p>В случае той же лампочки существует команда <code>Color</code> которая позволяет одновременно установить значения <code>X</code> и <code>Y</code>, но об этом опять чуть позже.<h1 id=home-assistant>Home Assistant</h1><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/home-assistant.png><figcaption class=center><p>Рис. 4. Home Assistant</p></figcaption></figure><p>Помните, я говорила, что Tasmota не умеет в автодискавери? Так вот. <br> Сейчас будем писать коньфиги. <br> Вручную. <br> И да поможет нам Nix, и его возможность писать человеческие функции для автогенерации YAML'а.<h2 id=mqtt-topiki>MQTT топики</h2><p>По-сути нам нужны только два топика: <code>tasmota/tele/tasmota_${gw_addr}/SENSOR</code> для чтения и <code>tasmota/cmnd/tasmota_${gw_addr}/ZbSend</code> для отправки команд. <br> Возможно ещё третий <code>tasmota/cmnd/tasmota_${gw_addr}/Backlog</code> для, собственно, Backlog команд.<p>Да, любую из списка команд можно вызвать через MQTT, отправив в соответствующий топик, где последняя часть и является названием команды.<p>Слать будем JSON'ы, парсить их тоже. Давайте к практике.<h3 id=vykliuchateli-i-sensory>Выключатели и сенсоры</h3><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/smart-socket.jpg><figcaption class=center><p>Рис 5. Выключатели с сенсорами</p></figcaption></figure><p>Давайте вспомним наш JSON из розетки<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x9AD4</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x9AD4</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>boiler_switch</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C13877C8106300</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS011F</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3000_cehuw1lw</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>P01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>RMSVoltage</span><span>": </span><span style=color:#d08770>226</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ActivePower</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>73</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806125</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>98
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Помимо <code>Power</code>, который управляет включением\выключением розетки, у нас есть ещё: <code>RMSVoltage</code> (меряет количество вольтов) и <code>ActivePower</code> (меряет количество амперов).<p>Поэтому начинаем писать конфиг:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>mqtt </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>switch </span><span>= [
</span><span>    {
</span><span>      </span><span style=color:#d08770>unique_id </span><span>= "</span><span style=color:#a3be8c>boiler_outlet_switch</span><span>";
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#a3be8c>Boiler Outlet Switch</span><span>";
</span><span>      </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_6A65EC/SENSOR</span><span>";
</span><span>      </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['0x9AD4'].Power }}</span><span>";
</span><span>      </span><span style=color:#d08770>command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_6A65EC/ZbSend</span><span>";
</span><span>      </span><span style=color:#d08770>payload_on </span><span>= ''</span><span style=color:#a3be8c>{"device":"0x9AD4","send":{"Power": "ON"}}</span><span>'';
</span><span>      </span><span style=color:#d08770>payload_off </span><span>= ''</span><span style=color:#a3be8c>{"device":"0x9AD4","send":{"Power": "OFF"}}</span><span>'';
</span><span>      </span><span style=color:#d08770>retain </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>      </span><span style=color:#d08770>device_class </span><span>= "</span><span style=color:#a3be8c>outlet</span><span>";
</span><span>      </span><span style=color:#d08770>device </span><span>= {
</span><span>        </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#a3be8c>Boiler Outlet</span><span>";
</span><span>        </span><span style=color:#d08770>model </span><span>= "</span><span style=color:#a3be8c>TS011F</span><span>";
</span><span>        </span><span style=color:#d08770>manufacturer </span><span>= "</span><span style=color:#a3be8c>Tuya</span><span>";
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ "</span><span style=color:#a3be8c>0x9AD4</span><span>" ];
</span><span>      };
</span><span>    }
</span><span>  ];
</span><span>}</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>Полное объяснение каждого параметра можно найти в соответствующей <a href=https://www.home-assistant.io/integrations/switch.mqtt/>документации</a>, так что пробегусь по важному:<p><code>state_topic</code> и <code>command_topic</code> — те самые топики для чтения состояния и отправки команд. Обычно сразу после получения команды девайс кинет сообщение с изменённым состоянием, что позволяет не надеяться на "оптимистичную" стратегию Home Assistant и, пускай и с небольшой задержкой, но знать актуальное состояние железяки.<p><code>value_template</code> — шаблон для вытаскивания значения параметра из JSON'а. Так как JSON'ы генерирует сам гетвей, можно смело копипастить шаблон из примера и только менять последнюю часть. Да, я тоже у кого-то это скопипастила.<p><code>payload_on</code> и <code>payload_off</code> — тут тоже всё понятно, однако чуть позже научимся их тоже шаблонизировать.<p>Разумеется, для каждой розетки писать такую портянку будет неприятно, поэтому оборачиваем всё в функцию:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>ts011f_switch </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> id: name: short_addr: gw_addr:
</span><span>  {
</span><span>    </span><span style=color:#d08770>unique_id </span><span>= </span><span style=color:#bf616a>id</span><span>;
</span><span>    </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>name</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c> Switch</span><span>";
</span><span>    </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr'</span><span style=color:#2b303b;background-color:#bf616a;font-style:italic>].</span><span style=color:#bf616a;font-style:italic>Power </span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>}</span><span>";
</span><span>    </span><span style=color:#d08770>command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>payload_on </span><span>= ''</span><span style=color:#a3be8c>{"device":"</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>","send":{"Power": "ON"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>payload_off </span><span>= ''</span><span style=color:#a3be8c>{"device":"</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>","send":{"Power": "OFF"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>retain </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>    </span><span style=color:#d08770>device_class </span><span>= "</span><span style=color:#a3be8c>outlet</span><span>";
</span><span>    </span><span style=color:#d08770>device </span><span>= {
</span><span>      </span><span style=color:#d08770>name </span><span>= </span><span style=color:#bf616a>name</span><span>;
</span><span>      </span><span style=color:#d08770>model </span><span>= "</span><span style=color:#a3be8c>TS011F</span><span>";
</span><span>      </span><span style=color:#d08770>manufacturer </span><span>= "</span><span style=color:#a3be8c>Tuya</span><span>";
</span><span>      </span><span style=color:#d08770>identifiers </span><span>= [ </span><span style=color:#bf616a>short_addr </span><span>];
</span><span>    };
</span><span>  }</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>Но у нас же ещё сенсоры остались. Так что пишем ещё функцю для них:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>ts011f_sensors </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> id: name: short_addr: gw_addr: 
</span><span>  [
</span><span>    {
</span><span>      </span><span style=color:#d08770>unique_id </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>id</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>_power</span><span>";
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>name</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c> Power</span><span>";
</span><span>      </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>      </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].ActivePower }}</span><span>";
</span><span>      </span><span style=color:#d08770>unit_of_measurement </span><span>= "</span><span style=color:#a3be8c>W</span><span>";
</span><span>      </span><span style=color:#d08770>device </span><span>= {
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span>" ];
</span><span>      };
</span><span>    }
</span><span>    {
</span><span>      </span><span style=color:#d08770>unique_id </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>id</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>_voltage</span><span>";
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>name</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c> Voltage</span><span>";
</span><span>      </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>      </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].RMSVoltage }}</span><span>";
</span><span>      </span><span style=color:#d08770>unit_of_measurement </span><span>= "</span><span style=color:#a3be8c>V</span><span>";
</span><span>      </span><span style=color:#d08770>device </span><span>= {
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span>" ];
</span><span>      };
</span><span>    }
</span><span>  ]</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>В итоге наш непосредственный конфиг выглядит красивенько и можем добавлять столько розеток, сколько у нас имеется (а у меня их как раз четыре штуки):<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>mqtt </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>switch </span><span>= [
</span><span>    (</span><span style=color:#bf616a>ts011f_switch </span><span>"</span><span style=color:#a3be8c>boiler_switch</span><span>" "</span><span style=color:#a3be8c>Boiler</span><span>" "</span><span style=color:#a3be8c>0x9AD4</span><span>" "</span><span style=color:#a3be8c>6A65EC</span><span>")
</span><span>  ];
</span><span>  </span><span style=color:#d08770>sensor </span><span>= (</span><span style=color:#bf616a>ts011f_sensors </span><span>"</span><span style=color:#a3be8c>boiler</span><span>" "</span><span style=color:#a3be8c>Boiler</span><span>" "</span><span style=color:#a3be8c>0x9AD4</span><span>" "</span><span style=color:#a3be8c>6A65EC</span><span>")
</span><span style=color:#2b303b;background-color:#bf616a>}</span><span>;
</span></code></pre><h2 id=lampochki>Лампочки</h2><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/smart-bulb.jpg><figcaption class=center><p>Рис 6. Лампочка</p></figcaption></figure><p>А теперь к самому сложному. Лампочки. <br> Лампочки — это совершенно проклятые устройства. <br> Они выглядят достаточно просто, но эта простота обманчива и заманивает несчастных на скалы безумия.<h3 id=skaly-bezumiia>Скалы безумия</h3><p>Давайте ещё раз на JSON посмотрим<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x7E20</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x7E20</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>main_light_0</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C138E23EE90340</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS0505B</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1</span><span>,
</span><span>        </span><span style=color:#d08770>242
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>~01.1</span><span>",
</span><span>        "</span><span style=color:#a3be8c>L01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Dimmer</span><span>": </span><span style=color:#d08770>254</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Hue</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Sat</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>X</span><span>": </span><span style=color:#d08770>24218</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Y</span><span>": </span><span style=color:#d08770>15601</span><span>,
</span><span>      "</span><span style=color:#a3be8c>CT</span><span>": </span><span style=color:#d08770>499</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ColorMode</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>RGB</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>RGBb</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>4</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806194</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>91
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Конкретно эта лампочка умеет менять мощность, температуру свечения и свой цвет.<p>На самом деле делает она это не одновременно, а переключаясь между режимами, которые можно достать из <code>ColorMode</code>. <br> Впрочем, эта информация нам нужна только для исследования и отладки.<p>Первый режим — это яркое свечение во всю мощщу с переменной температурой. За это отвечают параметры <code>Dimmer</code> и <code>CT</code> (Color Temperature) соответственно.<p>Второй и третий — это цветные. Отличаются они только способом выбора цвета: Hue\Sat или X\Y.<p>Логично предположить, что мы хотим менять параметры <code>Hue</code> и <code>Sat</code> или <code>X</code> и <code>Y</code>, но тут всплывает не самый очевидный с первого раза вопрос.<p><strong>А какие именно значения может принимать этот параметр?</strong><p>С одной стороны, тут можно положиться на здравый смысл. <br> Hue — это круг, значит диапазон значений должен быть 0..360. <br> А координатная система XY использует значения 0.0..1.0.<p>Но жизнь как всегда оказывается гораздо непредсказуемее, чем теория. <br> И мы таки имеем дело с лампочкой, которая одновременно выключатель и датчик влажности.<p>Так что единственный адекватный способ узнать настоящий диапазон значений — это тыкать палочкой и смотреть что получится.<p>К примеру, <code>Dimmer</code> имеет диапазон значений 0..254. Но при попытке выставить его в 255 лампочка начинает возвращать null, что весьма странно, ибо это ведь явно 8-битная переменная...<p>Мои попытки подобрать значения <code>Hue</code> и <code>Sat</code> ни к чему конструктивному не привели, а вот <code>X</code> и <code>Y</code> при попытке запихнуть в них значение не в диапазоне 0..65279, просто отказываются воспринимать команду. <br> Почему не 0..65535, как кто-то предложил в интернете, думая что это 16-битная переменная? <br> Ну вот потому что!<h3 id=sobiraem-vsio-v-home-assistant>Собираем всё в Home Assistant</h3><p>В результате, собрав все полученные в процессе тыкания палочкой знания, мы готовы написать функцию<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>tz3210_lamp </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> id: name: short_addr: gw_addr:
</span><span>  {
</span><span>    </span><span style=color:#d08770>unique_id </span><span>= </span><span style=color:#bf616a>id</span><span>;
</span><span>    </span><span style=color:#d08770>name </span><span>= </span><span style=color:#bf616a>name</span><span>;
</span><span>    </span><span style=color:#d08770>command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>payload_on </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": {"Power": "ON"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>payload_off </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": {"Power": "OFF"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>brightness_command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>brightness_command_template </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": { "Dimmer": "{{ value - 1 }}" }}</span><span>'';
</span><span>    </span><span style=color:#d08770>brightness_state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>brightness_value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].Dimmer }}</span><span>";
</span><span>    </span><span style=color:#d08770>xy_command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>xy_command_template </span><span>= ''</span><span style=color:#a3be8c>{"Device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send":{ "Color": "{{ x * 65279 }},{{ y * 65279 }}"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>xy_state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>xy_value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].X / 65279 }},{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].Y / 65279 }}</span><span>";
</span><span>    </span><span style=color:#d08770>color_temp_command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>color_temp_command_template </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": { "CT": "{{ value - 1 }}" }}</span><span>'';
</span><span>    </span><span style=color:#d08770>color_temp_state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>color_temp_value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].CT }}</span><span>";
</span><span>    </span><span style=color:#d08770>device </span><span>= {
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#a3be8c>RGB Lamp</span><span>";
</span><span>      </span><span style=color:#d08770>model </span><span>= "</span><span style=color:#a3be8c>TZ3210</span><span>";
</span><span>      </span><span style=color:#d08770>manufacturer </span><span>= "</span><span style=color:#a3be8c>Tuya</span><span>";
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ </span><span style=color:#bf616a>short_addr </span><span>];
</span><span>    };
</span><span>  }
</span></code></pre><p>Эта функция — просто сборник хаков, для того чтобы железка хоть как-то заработала. <br> Давайте пойдём по-порядку<p><code>Dimmer</code>, по мнению Home Assistant, должен принимать значения 0..255, но как мы уже знаем, максимальная циферка там 254, так что просто вычитаем единичку, всё равно оно в интерфейсе меньше чем в 3% не выставляется.<br> То же самое для <code>CT</code>.<p><code>X</code> и <code>Y</code>, по мнению того же Home Assistant, принимают значения от 0 до 1.0, поэтому преобразование туда\обратно делается элементарным умножением на максимально возможное значение<p>Кроме того, в <code>xy_command_template</code> тут используется функция <code>Color</code>, которая позволяет передать значения <code>X</code> и <code>Y</code> за одну команду, случайно найденная уже не помню где в обсуждении уже не помню какого устройства.<p>Если бы её не было, конфиг бы выглядел как-то так:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>xy_command_topic </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/Backlog</span><span>"</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span><span style=color:#bf616a>xy_command_template </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> ''</span><span style=color:#a3be8c>ZbSend {"Device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send":{ "X": "{{ x * 65279 }}"}}; ZbSend {"Device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send":{ "Y": "{{ y * 65279 }}"}}</span><span>''</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><h1 id=eto-konets>Это конец</h1><p>И на этой ноте мои приключения наконец-то закончились.<p>Лампочки моргают, бойлер выключается и даже аквариум обзавёлся своим удалённым управлением.<p>Мне категорически не понравилось умный дом делать, он какой-то слишком тупой оказался.<p>А наебалово с ценами огорчило меня ещё больше. <br> Пойду лучше на AliExpress железок докупать, там хотя бы модель явно пишут.<figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/bisexual-lighting.png><figcaption class=center><p>Рис. 7. Бисексуальное освещение</p></figcaption></figure></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Evgenia Vaartis</span><span class=copyright-theme> <span class=copyright-theme-sep>:: </span> Theme: <a href=https://github.com/pawroman/zola-theme-terminimal/>Terminimal</a> by pawroman </span></div></div></footer></div>