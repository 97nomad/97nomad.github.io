<!doctype html><html lang=en><head><title>Just Nommy</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://blog.nommy.moe/style.css rel=stylesheet><link href=https://blog.nommy.moe/color/red.css rel=stylesheet><link href=https://blog.nommy.moe/color/background_blue.css rel=stylesheet><link href=https://blog.nommy.moe/font-hack.css rel=stylesheet><meta name=description><meta property=og:description><meta content="Just Nommy" property=og:title><meta content=article property=og:type><meta content=https://blog.nommy.moe/blog/tasmota-tuya-perversions/ property=og:url><meta content=summary_large_image name=twitter:card><meta name=twitter:description><meta content="Just Nommy" name=twitter:title><meta content=blog.nommy.moe property=twitter:domain><meta content=https://blog.nommy.moe/blog/tasmota-tuya-perversions/ property=twitter:url><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a href=https://blog.nommy.moe style=text-decoration:none> <div class=logo>Just Nommy</div> </a></div></div><nav class=menu><ul class=menu__inner><li><a href=https://blog.nommy.moe/about>About Me</a><li class=active><a href=https://blog.nommy.moe/blog>Blog</a><li><a href=https://blog.nommy.moe/blog_ru>Blog [Ru]</a><li><a href=https://github.com/97nomad/>GitHub</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://blog.nommy.moe/blog/tasmota-tuya-perversions/>Connecting Tasmota to Home Assistant and other weird noname devices</a></h1><div class=post-meta-inline><span class=post-date> 2025-03-12 </span></div><span class=post-tags-inline> :: tags:  <a class=post-tag href=https://blog.nommy.moe/tags/en/>#en</a>  <a class=post-tag href=https://blog.nommy.moe/tags/hass/>#hass</a>  <a class=post-tag href=https://blog.nommy.moe/tags/smarthome/>#smarthome</a>  <a class=post-tag href=https://blog.nommy.moe/tags/tasmota/>#tasmota</a></span><div class=post-content><h1 id=what-problem-do-we-have>What problem do we have?</h1><p>One day, a very naughty person decided that wiring the whole house (including the electric stove) on a single 2.5mm² was a very good idea.<p>Fire safety regulations and automatic fuses didn't see it that way.<p>So turning on the boiler and the oven at the same time causes a complete power outage in a single apartment, which frustrates me a lot. And going to unplug the boiler every time is definitely not something I want to do.<p>And because of this we are going to make a smart home so that I can control the boiler at least from my smartphone.<h1 id=la-planchas>La Planchas</h1><p>A quick search on Amazon gave me <code>SONOFF Zigbee Bridge 3.0 Gateway Hub, ,Soporte de Protocolo Dual,WiFi, Compatible con Dispositivos Zigbee Pro, Alexa & Google</code>, aka <code>SONOFF ZBBridge-P</code> only for 35€. <br> A quick googling revealed that there's some kind of opensource firmware for it. “I should buy it”, I thought.<p>At the same time to the cart went <code>ZigBee Enchufe Inteligente Alexa 16A, 3680W Smart Plug con Monitor de Energía, Enchufe Temporizador con Control Remoto, Control por Voz y Funciones de Temporización, apoyo Alexa & Google Home</code> (4 pieces for 45€), which later turned out to be <code>Tuya TS011F</code>.<p>And also for the change was thrown in <code>Garza Smart - Bombilla LED Zigbee Estándar A60, 11W (equivale a 75W de incandescencia), E27, Requiere Puente/Bridge, RGB + CCT, Intensidad regulable, Programable, Control por voz y app, Alexa/Google</code>, which for some reason pretended to be <code>Tuya TZ3210</code>. <br> What exactly this <code>TZ3210</code> is, I have not been able to establish, because various sources say that it is either a switch, a humidity and temperature sensor, or as I can guess an RGB lightbulb.<h1 id=curing-the-bridge-from-the-cloud>Curing the bridge from the cloud</h1><p>Since it's <em>mauvais</em> to dump smarthome data to some obscure cloud, the first thing to do is to put a new firmware in the bridge.<p>I followed this very detailed instruction <a href=https://notenoughtech.com/home-automation/tasmota-on-sonoff-zb-bridge-pro/>How to flash Tasmota on Sonoff ZB Bridge Pro</a>.<p>The only thing that caused some confusion is the <code>GPIO00</code> pin. It should be pulled up to <code>GND</code> during the startup to put this <em>la plancha</em> into UART mode. <br> I had some difficult time with this, so you can track the success of the operation with elegant <code>screen /dev/ttyACM0 115200</code> and then looking at the startup logs.<p>I won't describe the complete flashing process, as it's perfectly described in the link above, but...<figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/how-to-get-heart-attack.jpg><figcaption class=center><p>Fig. 1. How to suddenly get heart attack</p></figcaption></figure><p>Fortunately, this bug was fixed a long time ago and someone just didn't update Flipper's firmware for a long time.<h1 id=setting-up-secured-mqtt>Setting up secured MQTT</h1><p>Despite the fact that ESP32 already has Wireguard implementation, Tasmota still doesn't support it, so I have to put MQTT server outside and configure SSL on it, so that random vanderers don't have fun with my sockets.<p>And with a slight <code>nixos-rebuild switch ...</code>, we will put Mosquitto on an external server with a static IP<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>users</span><span>.</span><span style=color:#bf616a>users</span><span>.</span><span style=color:#bf616a>mosquitto</span><span>.</span><span style=color:#bf616a>extraGroups </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> [ "</span><span style=color:#a3be8c>nginx</span><span>" ]</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span><span style=color:#bf616a>services</span><span>.</span><span style=color:#bf616a>mosquitto </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>enable </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>  </span><span style=color:#d08770>listeners </span><span>= [
</span><span>    {
</span><span>      </span><span style=color:#d08770>address </span><span>= "</span><span style=color:#a3be8c>123.456.789.123</span><span>";
</span><span>      </span><span style=color:#d08770>port </span><span>= </span><span style=color:#d08770>1883</span><span>;
</span><span>      </span><span style=color:#d08770>users </span><span>= {
</span><span>        </span><span style=color:#d08770>tasmota </span><span>= {
</span><span>          </span><span style=color:#d08770>acl </span><span>= [
</span><span>            "</span><span style=color:#a3be8c>readwrite tasmota/#</span><span>"
</span><span>          ];
</span><span>          </span><span style=color:#d08770>password </span><span>= "</span><span style=color:#a3be8c>changeme</span><span>";
</span><span>        };
</span><span>      };
</span><span>      </span><span style=color:#d08770>settings </span><span>= {
</span><span>        "</span><span style=color:#a3be8c>allow_anonymous</span><span>" = </span><span style=color:#d08770>false</span><span>;
</span><span>        "</span><span style=color:#a3be8c>require_certificate</span><span>" = </span><span style=color:#d08770>false</span><span>;
</span><span>        "</span><span style=color:#a3be8c>cafile</span><span>" = "</span><span style=color:#a3be8c>/var/lib/acme/mqtt.example.com/fullchain.pem</span><span>";
</span><span>        "</span><span style=color:#a3be8c>certfile</span><span>" = "</span><span style=color:#a3be8c>/var/lib/acme/mqtt.example.com/cert.pem</span><span>";
</span><span>        "</span><span style=color:#a3be8c>keyfile</span><span>" = "</span><span style=color:#a3be8c>/var/lib/acme/mqtt.example.com/key.pem</span><span>";
</span><span>        "</span><span style=color:#a3be8c>tls_version</span><span>" = "</span><span style=color:#a3be8c>tlsv1.2</span><span>";
</span><span>      };
</span><span>    }
</span><span>    {
</span><span>      </span><span style=color:#d08770>address </span><span>= "</span><span style=color:#a3be8c>10.20.0.1</span><span>";
</span><span>      </span><span style=color:#d08770>port </span><span>= </span><span style=color:#d08770>1883</span><span>;
</span><span>      </span><span style=color:#d08770>users </span><span>= {
</span><span>        </span><span style=color:#d08770>hass </span><span>= {
</span><span>          </span><span style=color:#d08770>acl </span><span>= [
</span><span>            "</span><span style=color:#a3be8c>readwrite #</span><span>"
</span><span>          ];
</span><span>          </span><span style=color:#d08770>password </span><span>= "</span><span style=color:#a3be8c>changeme</span><span>";
</span><span>        };
</span><span>      };
</span><span>    }
</span><span>  ];
</span><span>}</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>The <code>mosquitto</code> user was sent to the <code>nginx</code> group just to be able to use Let's Encrypt certificates.<p>I'm also using a system with two listeners. One is SSL protected, restricted to the core and looks outside, and the second one is in the internal VPN network, allowing to connect other clients, but about this later<p>Also worth noting are the lines <code>“require_certificate” = false;</code> and <code>“tls_version” = “tlsv1.2</code>. <br> First line disables TLS authorization, leaving the password one, and the second enables traffic encryption. <br> Without the first one Tasmota cannot connect to MQTT, and without the second one Mosquitto will ignore all configured certificates and work in unprotected mode.<p>On the Home Assistant side I have configured a bridge that will take all messages from the external MQTT and put them into the main MQTT. <br> Just because I already had MQTT configured for local stuff and didn't want to touch it.<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>services</span><span>.</span><span style=color:#bf616a>mosquitto </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>enable </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>  </span><span style=color:#d08770>listeners </span><span>= [
</span><span>    </span><span style=color:#2b303b;background-color:#bf616a>...</span><span>
</span><span>  ];
</span><span>  </span><span style=color:#d08770>bridges </span><span>= {
</span><span>    "</span><span style=color:#a3be8c>external2internal</span><span>" = {
</span><span>      </span><span style=color:#d08770>addresses </span><span>= [
</span><span>        { </span><span style=color:#d08770>address </span><span>= "</span><span style=color:#a3be8c>10.20.0.1</span><span>"; </span><span style=color:#d08770>port </span><span>= </span><span style=color:#d08770>1883</span><span>; }
</span><span>      ];
</span><span>      </span><span style=color:#d08770>topics </span><span>= [
</span><span>        "</span><span style=color:#a3be8c>tasmota/# in</span><span>"
</span><span>        "</span><span style=color:#a3be8c>tasmota/cmnd/# out</span><span>"
</span><span>      ];
</span><span>      </span><span style=color:#d08770>settings </span><span>= {
</span><span>        </span><span style=color:#d08770>remote_username </span><span>= "</span><span style=color:#a3be8c>hass</span><span>";
</span><span>        </span><span style=color:#d08770>remote_password </span><span>= "</span><span style=color:#a3be8c>changeme</span><span>";
</span><span>      };
</span><span>    };
</span><span>  };
</span><span>}</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>With this topics setup, I don't pull anything extra inside, and only direct commands for Tasmota can go outside.<p>But of course this can be skipped if there is only one MQTT.<p><strong>AND DON'T FORGET TO OPEN THE PORT ON YOUR FIREWALL!</strong><h1 id=connecting-the-bridge-to-the-secured-mqtt>Connecting the bridge to the secured MQTT</h1><img class=center decoding=async loading=lazy src=https://blog.nommy.moe/blog/tasmota-tuya-perversions/tasmota-mqtt-settings.png><p>It's already obvious and self-explanatory here, except for a couple things.<p>Be sure to click the <code>MQTT TLS</code> checkbox so that it will be able to connect to our secure Mosquitto.<p>And in the <code>Full Topic</code> field you should add <code>tasmota/</code> in the beginning, so that all messages are neatly piled into one group and we won't write each bridge address into ACL.<p>After pairing devices with the bridge (Just press the <code>Zigbee Permit Join</code> button and turn on <em>las planchas</em>), it is not unreasonable to check if everything is working properly and the messages from the devices are getting to MQTT. <br> Subscribe to <code>tasmota/#</code> and wait for something to be appeared there.<p>If nothing appeared for a long time, go back to the beginning and think about what can went wrong.<p>Repeat until you are completely satisfied.<h1 id=exploring-the-devices>Exploring the devices</h1><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/sonoff-bridge.jpg><figcaption class=center><p>Fig. 2. SONOFF ZB Bridge-P</p></figcaption></figure><p>This is where the hell and Wisconsin begins.<p>The thing is that Tasmota can't do auto discovery. To be more precise, it can, but only for Tasmota running end devices and through their own plugin. <br> And since we have a bridge, two facts follow from this:<ol><li>We don't need a plugin, raw MQTT is more than enough.<li>No one will help us.</ol><p>But first we should arm ourselves with the console on the bridge itself and see what we have there.<p>{{ figure(src=“/blog/tasmota-tuya-perversions/tasmota-console.png”, caption="Fig. 3. Green and scary") }}}<p>We go to <code>Tools > Console</code> in the bridge web interface and start poking everything around with a stick.<p>The full list of commands can be found here: <a href=https://tasmota.github.io/docs/Commands/>Tasmota Commands</a>, but we are only interested in the <a href=https://tasmota.github.io/docs/Commands/#zigbee>Zigbee</a> part.<p>To be more precise, the commands <code>ZbInfo</code>, <code>ZbName</code> and <code>ZbSend</code>.<h3 id=zbinfo>ZbInfo</h3><p>By typing <code>ZbInfo</code> into the terminal, you can get (mostly) all information about the connected devices. <br> The result is usually a mess like this<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.524</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>7E20</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x7E20</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x7E20</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>main_light_0</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C138E23EE90340</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS0505B</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>,</span><span style=color:#d08770>242</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>O01</span><span>","</span><span style=color:#a3be8c>~01.1</span><span>","</span><span style=color:#a3be8c>L01</span><span>"],"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>1</span><span>,"</span><span style=color:#a3be8c>Dimmer</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>Hue</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Sat</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>X</span><span>":</span><span style=color:#d08770>24218</span><span>,"</span><span style=color:#a3be8c>Y</span><span>":</span><span style=color:#d08770>15601</span><span>,"</span><span style=color:#a3be8c>CT</span><span>":</span><span style=color:#d08770>499</span><span>,"</span><span style=color:#a3be8c>ColorMode</span><span>":</span><span style=color:#d08770>1</span><span>,"</span><span style=color:#a3be8c>RGB</span><span>":"</span><span style=color:#a3be8c>FFFFFF</span><span>","</span><span style=color:#a3be8c>RGBb</span><span>":"</span><span style=color:#a3be8c>FFFFFF</span><span>","</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>4</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806194</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>91</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.536</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/CD</span><span style=color:#d08770>47</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0xCD47</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0xCD47</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>aquarium_light</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C1382214F48A12</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>P01</span><span>","</span><span style=color:#a3be8c>O01</span><span>"],"</span><span style=color:#a3be8c>RMSVoltage</span><span>":</span><span style=color:#d08770>226</span><span>,"</span><span style=color:#a3be8c>ActivePower</span><span>":</span><span style=color:#d08770>10</span><span>,"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>1</span><span>,"</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>6</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806192</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>185</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.548</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>9</span><span>AD</span><span style=color:#d08770>4</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x9AD4</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x9AD4</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>boiler_switch</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C13877C8106300</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS011F</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3000_cehuw1lw</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>P01</span><span>","</span><span style=color:#a3be8c>O01</span><span>"],"</span><span style=color:#a3be8c>RMSVoltage</span><span>":</span><span style=color:#d08770>226</span><span>,"</span><span style=color:#a3be8c>ActivePower</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>73</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806125</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>98</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.563</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>3</span><span>B</span><span style=color:#d08770>30</span><span>/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x3B30</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x3B30</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>main_light_1</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C1381A825F2ADE</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS0505B</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>,</span><span style=color:#d08770>242</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>~01.1</span><span>","</span><span style=color:#a3be8c>O01</span><span>","</span><span style=color:#a3be8c>L01</span><span>"],"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Dimmer</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>Hue</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Sat</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>X</span><span>":</span><span style=color:#d08770>38449</span><span>,"</span><span style=color:#a3be8c>Y</span><span>":</span><span style=color:#d08770>21476</span><span>,"</span><span style=color:#a3be8c>CT</span><span>":</span><span style=color:#d08770>283</span><span>,"</span><span style=color:#a3be8c>ColorMode</span><span>":</span><span style=color:#d08770>2</span><span>,"</span><span style=color:#a3be8c>RGB</span><span>":"</span><span style=color:#a3be8c>FF0000</span><span>","</span><span style=color:#a3be8c>RGBb</span><span>":"</span><span style=color:#a3be8c>FF0000</span><span>","</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>136</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806062</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>163</span><span>}}}
</span><span style=color:#d08770>20</span><span>:</span><span style=color:#d08770>03</span><span>:</span><span style=color:#d08770>18.578</span><span> MQT: tasmota/tele/tasmota_</span><span style=color:#d08770>6</span><span>A</span><span style=color:#d08770>65</span><span>EC/</span><span style=color:#d08770>898</span><span>A/SENSOR = {"</span><span style=color:#a3be8c>ZbInfo</span><span>":{"</span><span style=color:#a3be8c>0x898A</span><span>":{"</span><span style=color:#a3be8c>Device</span><span>":"</span><span style=color:#a3be8c>0x898A</span><span>","</span><span style=color:#a3be8c>Name</span><span>":"</span><span style=color:#a3be8c>studio_light</span><span>","</span><span style=color:#a3be8c>IEEEAddr</span><span>":"</span><span style=color:#a3be8c>0xA4C1389F99E433CE</span><span>","</span><span style=color:#a3be8c>ModelId</span><span>":"</span><span style=color:#a3be8c>TS0505B</span><span>","</span><span style=color:#a3be8c>Manufacturer</span><span>":"</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>","</span><span style=color:#a3be8c>Endpoints</span><span>":[</span><span style=color:#d08770>1</span><span>,</span><span style=color:#d08770>242</span><span>],"</span><span style=color:#a3be8c>Config</span><span>":["</span><span style=color:#a3be8c>O01</span><span>","</span><span style=color:#a3be8c>~01.1</span><span>","</span><span style=color:#a3be8c>L01</span><span>"],"</span><span style=color:#a3be8c>Power</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Dimmer</span><span>":</span><span style=color:#d08770>42</span><span>,"</span><span style=color:#a3be8c>Hue</span><span>":</span><span style=color:#d08770>0</span><span>,"</span><span style=color:#a3be8c>Sat</span><span>":</span><span style=color:#d08770>254</span><span>,"</span><span style=color:#a3be8c>X</span><span>":</span><span style=color:#d08770>13578</span><span>,"</span><span style=color:#a3be8c>Y</span><span>":</span><span style=color:#d08770>14165</span><span>,"</span><span style=color:#a3be8c>CT</span><span>":</span><span style=color:#d08770>283</span><span>,"</span><span style=color:#a3be8c>ColorMode</span><span>":</span><span style=color:#d08770>2</span><span>,"</span><span style=color:#a3be8c>RGB</span><span>":"</span><span style=color:#a3be8c>FF0000</span><span>","</span><span style=color:#a3be8c>RGBb</span><span>":"</span><span style=color:#a3be8c>2A0000</span><span>","</span><span style=color:#a3be8c>Reachable</span><span>":</span><span style=color:#d08770>true</span><span>,"</span><span style=color:#a3be8c>LastSeen</span><span>":</span><span style=color:#d08770>150</span><span>,"</span><span style=color:#a3be8c>LastSeenEpoch</span><span>":</span><span style=color:#d08770>1741806048</span><span>,"</span><span style=color:#a3be8c>LinkQuality</span><span>":</span><span style=color:#d08770>65</span><span>}}}
</span></code></pre><p>If you sit and read carefully, you can find:<ul><li><code>Device</code> - Short device address (0xAAAA). Usually used to refer to the device.<li><code>ModelId</code> and <code>Manufacturer</code> - The actual description of the model. If you look at the beginning of the article, you can see that cheap Chinese Tuya can be found under various pathos brands, but this is the place where the truth is revealed.<li><code>Dimmer</code>, <code>Hue</code>, <code>Sat</code>, <code>X</code>, <code>Y</code> and all other hardware-specific parameters that this device will send to MQTT.</ul><p>The last ones will be especially useful for us, but we will talk about it later.<h3 id=zbname>ZbName</h3><p>Now it's about time to give all devices readable names so that we don't get confused later.<p><code>ZbName short_address,name</code> will help us with this. Then this name will still pop up in every event and we can do something using it, but the main goal is just not to get confused.<h3 id=zbsend>ZbSend</h3><p>And now we can actively poke the device with the stick, because <code>ZbSend</code> allows us to send some message and see how the device reacts.<p>We can, for example, put a stick in the smart socket.<p><code>ZbSend { “device”: “0x9AD4”, “send”: { “power”: “ON“ }}</code> will turn the smart socket on, and <code>ZbSend {”device": ‘0x9AD4’, ‘send’: { “Power”: “OFF” }}</code> will turn it off, correspondingly.<p>How we know, that we need to send message <code>{ “Power”: “ON” }</code> is the most interesting question.<p>And the answer to it would be <em>"just guess"</em>, but that's not actually true.<p>Let's take a closer look at the JSON from the output of the <code>ZbInfo 0x9AD4</code> command<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x9AD4</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x9AD4</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>boiler_switch</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C13877C8106300</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS011F</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3000_cehuw1lw</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>P01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>RMSVoltage</span><span>": </span><span style=color:#d08770>226</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ActivePower</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>73</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806125</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>98
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>Among other things, here you can see the <code>Power</code> field with the value <code>0</code>, i.e. “Off”. <br> And the trick with more readable <code>ON</code> and <code>OFF</code> I just found up in the Internets.<p>And if you look at the JSON from the lightbulb, there's more interesting stuff here.<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x7E20</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x7E20</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>main_light_0</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C138E23EE90340</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS0505B</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1</span><span>,
</span><span>        </span><span style=color:#d08770>242
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>~01.1</span><span>",
</span><span>        "</span><span style=color:#a3be8c>L01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Dimmer</span><span>": </span><span style=color:#d08770>254</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Hue</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Sat</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>X</span><span>": </span><span style=color:#d08770>24218</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Y</span><span>": </span><span style=color:#d08770>15601</span><span>,
</span><span>      "</span><span style=color:#a3be8c>CT</span><span>": </span><span style=color:#d08770>499</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ColorMode</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>RGB</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>RGBb</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>4</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806194</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>91
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>In addition to <code>Power</code> we also have <code>Dimmer</code>, <code>Hue</code>, <code>Sat</code>, <code>X</code>, <code>Y</code>, <code>CT</code>, <code>ColorMode</code>, <code>RGB</code> and <code>RGBb</code>. <br> Spoiler: not all of these can be changed in the same way, but we have a general direction for digging for the API.<h3 id=one-more-thing-to-mention-backlog>One more thing to mention (Backlog)</h3><p>Ah, yes. There's one more thing to mention.<p>Even though we can do <code>ZbSend { “device”: “0x7E20”, “send”: { “hue”: “128” }}</code>, <br> We can't do <code>ZbSend { “device”: “0x7E20”, “send”: { “hue”: “128”, “sat”: “254” }}</code> because we can change only one parameter per request.<p>As a quick workaround for the problem, you can use <a href=https://tasmota.github.io/docs/Commands/#the-power-of-backlog>Backlog</a>, the built-in language...<p>In short, you can just pass several commands in a row to this thing, and then they will be executed sequentially. <br> And as a result, our command will look something like this:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>Backlog ZbSend { “device”: “0x7E20”, “send”: { “Hue”: “128” }}; ZbSend { “device”: “0x7E20”, “send”: { “sat”: “254” }}
</span></code></pre><p>Good for quick hacks, but in practice it turns out that sending two commands is not the fastest process and instead you can sometimes find “undocumented” commands.<p>In case of this lightbulb there is a command <code>Color</code> which allows to set <code>X</code> and <code>Y</code> values at the same time, but about this again a little later.<h1 id=home-assistant>Home Assistant</h1><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/home-assistant.png><figcaption class=center><p>Fig. 4. Home Assistant</p></figcaption></figure><p>Remember when I said that Tasmota doesn't know how to do auto discovery? Well, here it is. <br> We're gonna write the configs. <br> By hands. <br> And may Nix and its ability to write functions for autogenerating YAML help us.<h2 id=mqtt-topics>MQTT Topics</h2><p>Essentially we only need two topics: <code>tasmota/tele/tasmota_${gw_addr}/SENSOR</code> to read data and <code>tasmota/cmnd/tasmota_${gw_addr}/ZbSend</code> to send commands. <br> Perhaps a third <code>tasmota/cmnd/tasmota_${gw_addr}/Backlog</code> for executing Backlog commands.<p>Yes, any of the commands from the list can be called via MQTT by sending it to the appropriate topic, where the last part is the name of the command.<p>We will send JSON's and parse them too. Let's get to practice.<h3 id=switches-and-sensors>Switches and sensors</h3><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/smart-socket.jpg><figcaption class=center><p>Fig. 5. Switches with sensors</p></figcaption></figure><p>Let's remember out JSON from the socket<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x9AD4</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x9AD4</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>boiler_switch</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C13877C8106300</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS011F</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3000_cehuw1lw</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>P01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>RMSVoltage</span><span>": </span><span style=color:#d08770>226</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ActivePower</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>73</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806125</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>98
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>In addition to <code>Power</code>, which controls turning the socket on and off, we also have <code>RMSVoltage</code> (measures the amount of volts) and <code>ActivePower</code> (measures the amount of ampers).<p>So let's go to writing the config:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>mqtt </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>switch </span><span>= [
</span><span>    {
</span><span>      </span><span style=color:#d08770>unique_id </span><span>= "</span><span style=color:#a3be8c>boiler_outlet_switch</span><span>";
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#a3be8c>Boiler Outlet Switch</span><span>";
</span><span>      </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_6A65EC/SENSOR</span><span>";
</span><span>      </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['0x9AD4'].Power }}</span><span>";
</span><span>      </span><span style=color:#d08770>command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_6A65EC/ZbSend</span><span>";
</span><span>      </span><span style=color:#d08770>payload_on </span><span>= ''</span><span style=color:#a3be8c>{"device":"0x9AD4","send":{"Power": "ON"}}</span><span>'';
</span><span>      </span><span style=color:#d08770>payload_off </span><span>= ''</span><span style=color:#a3be8c>{"device":"0x9AD4","send":{"Power": "OFF"}}</span><span>'';
</span><span>      </span><span style=color:#d08770>retain </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>      </span><span style=color:#d08770>device_class </span><span>= "</span><span style=color:#a3be8c>outlet</span><span>";
</span><span>      </span><span style=color:#d08770>device </span><span>= {
</span><span>        </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#a3be8c>Boiler Outlet</span><span>";
</span><span>        </span><span style=color:#d08770>model </span><span>= "</span><span style=color:#a3be8c>TS011F</span><span>";
</span><span>        </span><span style=color:#d08770>manufacturer </span><span>= "</span><span style=color:#a3be8c>Tuya</span><span>";
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ "</span><span style=color:#a3be8c>0x9AD4</span><span>" ];
</span><span>      };
</span><span>    }
</span><span>  ];
</span><span>}</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>A full explanation of each parameter can be found in the corresponding <a href=https://www.home-assistant.io/integrations/switch.mqtt/>documentation</a>, so I'll run through the important stuff:<p><code>state_topic</code> and <code>command_topic</code> are those topics for reading the state and sending commands. Usually right after receiving a command a device will throw a message with the changed state, which allows you not to rely on the “optimistic” strategy of Home Assistant and, albeit with a slight delay, but to know the actual state of the hardware.<p><code>value_template</code> - a template for pulling a parameter value from JSON. Since JSON's are generated by the getway itself, you can copy the template from the example and only change the last part. Yes, I copied that from someone else too.<p><code>payload_on</code> and <code>payload_off</code> - everything is clear here too, but later we will learn how to template them.<p>Of course, it will be unpleasant to write such a mess for each socket, so let's wrap everything in a function:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>ts011f_switch </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> id: name: short_addr: gw_addr:
</span><span>  {
</span><span>    </span><span style=color:#d08770>unique_id </span><span>= </span><span style=color:#bf616a>id</span><span>;
</span><span>    </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>name</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c> Switch</span><span>";
</span><span>    </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr'</span><span style=color:#2b303b;background-color:#bf616a;font-style:italic>].</span><span style=color:#bf616a;font-style:italic>Power </span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>}</span><span>";
</span><span>    </span><span style=color:#d08770>command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>payload_on </span><span>= ''</span><span style=color:#a3be8c>{"device":"</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>","send":{"Power": "ON"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>payload_off </span><span>= ''</span><span style=color:#a3be8c>{"device":"</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>","send":{"Power": "OFF"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>retain </span><span>= </span><span style=color:#d08770>true</span><span>;
</span><span>    </span><span style=color:#d08770>device_class </span><span>= "</span><span style=color:#a3be8c>outlet</span><span>";
</span><span>    </span><span style=color:#d08770>device </span><span>= {
</span><span>      </span><span style=color:#d08770>name </span><span>= </span><span style=color:#bf616a>name</span><span>;
</span><span>      </span><span style=color:#d08770>model </span><span>= "</span><span style=color:#a3be8c>TS011F</span><span>";
</span><span>      </span><span style=color:#d08770>manufacturer </span><span>= "</span><span style=color:#a3be8c>Tuya</span><span>";
</span><span>      </span><span style=color:#d08770>identifiers </span><span>= [ </span><span style=color:#bf616a>short_addr </span><span>];
</span><span>    };
</span><span>  }</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>Wait, we also have sensors. So, we are writing functions for them too:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>ts011f_sensors </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> id: name: short_addr: gw_addr: 
</span><span>  [
</span><span>    {
</span><span>      </span><span style=color:#d08770>unique_id </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>id</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>_power</span><span>";
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>name</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c> Power</span><span>";
</span><span>      </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>      </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].ActivePower }}</span><span>";
</span><span>      </span><span style=color:#d08770>unit_of_measurement </span><span>= "</span><span style=color:#a3be8c>W</span><span>";
</span><span>      </span><span style=color:#d08770>device </span><span>= {
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span>" ];
</span><span>      };
</span><span>    }
</span><span>    {
</span><span>      </span><span style=color:#d08770>unique_id </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>id</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>_voltage</span><span>";
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>name</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c> Voltage</span><span>";
</span><span>      </span><span style=color:#d08770>state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>      </span><span style=color:#d08770>value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].RMSVoltage }}</span><span>";
</span><span>      </span><span style=color:#d08770>unit_of_measurement </span><span>= "</span><span style=color:#a3be8c>V</span><span>";
</span><span>      </span><span style=color:#d08770>device </span><span>= {
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span>" ];
</span><span>      };
</span><span>    }
</span><span>  ]</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><p>As a result, our config immediately starts to look nicer and we can add as many outlets as we have (and I have four of them):<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>mqtt </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> {
</span><span>  </span><span style=color:#d08770>switch </span><span>= [
</span><span>    (</span><span style=color:#bf616a>ts011f_switch </span><span>"</span><span style=color:#a3be8c>boiler_switch</span><span>" "</span><span style=color:#a3be8c>Boiler</span><span>" "</span><span style=color:#a3be8c>0x9AD4</span><span>" "</span><span style=color:#a3be8c>6A65EC</span><span>")
</span><span>  ];
</span><span>  </span><span style=color:#d08770>sensor </span><span>= (</span><span style=color:#bf616a>ts011f_sensors </span><span>"</span><span style=color:#a3be8c>boiler</span><span>" "</span><span style=color:#a3be8c>Boiler</span><span>" "</span><span style=color:#a3be8c>0x9AD4</span><span>" "</span><span style=color:#a3be8c>6A65EC</span><span>")
</span><span style=color:#2b303b;background-color:#bf616a>}</span><span>;
</span></code></pre><h2 id=lightbulbs>Lightbulbs</h2><figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/smart-bulb.jpg><figcaption class=center><p>Fig. 6. Lightbulb</p></figcaption></figure><p>Now for the hard part. Lightbulbs. <br> Lightbulbs are completely cursed devices. <br> They look simple enough, but that simplicity is deceptive and lures the unfortunate people to the cliffs of insanity.<h3 id=cliffs-of-insanity>Cliffs of insanity</h3><p>Let's take another look at JSON<pre class=language-json data-lang=json style=color:#c0c5ce;background-color:#2b303b><code class=language-json data-lang=json><span>{
</span><span>  "</span><span style=color:#a3be8c>ZbInfo</span><span>": {
</span><span>    "</span><span style=color:#a3be8c>0x7E20</span><span>": {
</span><span>      "</span><span style=color:#a3be8c>Device</span><span>": "</span><span style=color:#a3be8c>0x7E20</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Name</span><span>": "</span><span style=color:#a3be8c>main_light_0</span><span>",
</span><span>      "</span><span style=color:#a3be8c>IEEEAddr</span><span>": "</span><span style=color:#a3be8c>0xA4C138E23EE90340</span><span>",
</span><span>      "</span><span style=color:#a3be8c>ModelId</span><span>": "</span><span style=color:#a3be8c>TS0505B</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Manufacturer</span><span>": "</span><span style=color:#a3be8c>_TZ3210_4sku4dkz</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Endpoints</span><span>": [
</span><span>        </span><span style=color:#d08770>1</span><span>,
</span><span>        </span><span style=color:#d08770>242
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Config</span><span>": [
</span><span>        "</span><span style=color:#a3be8c>O01</span><span>",
</span><span>        "</span><span style=color:#a3be8c>~01.1</span><span>",
</span><span>        "</span><span style=color:#a3be8c>L01</span><span>"
</span><span>      ],
</span><span>      "</span><span style=color:#a3be8c>Power</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Dimmer</span><span>": </span><span style=color:#d08770>254</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Hue</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Sat</span><span>": </span><span style=color:#d08770>0</span><span>,
</span><span>      "</span><span style=color:#a3be8c>X</span><span>": </span><span style=color:#d08770>24218</span><span>,
</span><span>      "</span><span style=color:#a3be8c>Y</span><span>": </span><span style=color:#d08770>15601</span><span>,
</span><span>      "</span><span style=color:#a3be8c>CT</span><span>": </span><span style=color:#d08770>499</span><span>,
</span><span>      "</span><span style=color:#a3be8c>ColorMode</span><span>": </span><span style=color:#d08770>1</span><span>,
</span><span>      "</span><span style=color:#a3be8c>RGB</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>RGBb</span><span>": "</span><span style=color:#a3be8c>FFFFFF</span><span>",
</span><span>      "</span><span style=color:#a3be8c>Reachable</span><span>": </span><span style=color:#d08770>true</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeen</span><span>": </span><span style=color:#d08770>4</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LastSeenEpoch</span><span>": </span><span style=color:#d08770>1741806194</span><span>,
</span><span>      "</span><span style=color:#a3be8c>LinkQuality</span><span>": </span><span style=color:#d08770>91
</span><span>    }
</span><span>  }
</span><span>}
</span></code></pre><p>This particular bulb can change power, temperature and color.<p>In fact, it doesn't do this simultaneously, but rather switches between modes, that we can see in <code>ColorMode</code> parameter. <br> However, we need this information only for research and debugging.<p>The first mode is a bright glow at full power with variable temperature. The parameters <code>Dimmer</code> and <code>CT</code> (Color Temperature) are responsible for this, correspondingly.<p>The second and third modes are RGB modes. They differ only in the way of color selection: Hue\Sat or X\Y.<p>It is logical to assume that we want to change the parameters <code>Hue</code> and <code>Sat</code> or <code>X</code> and <code>Y</code>, but here comes a question that is not the most obvious from the first time.<p><strong>What exactly are the values that this parameters can take?</strong><p>On the one hand, we can rely on common sense. <br> Hue is a circle, so the range of values should be 0...360. <br> And the XY coordinate system uses range 0.0 to 1.0.<p>But life is always more unpredictable than the theory. <br> And we are dealing with a lightbulb that is both a switch and a humidity sensor.<p>So the only adequate way to know the real range of values is to poke them with a stick and see what happens.<p>For example, <code>Dimmer</code> has a value range of 0...254. But when trying to set it to 255, the bulb returns null, which is very strange, because it is obviously an 8-bit variable...<p>My attempts to find the values of <code>Hue</code> and <code>Sat</code> did not lead to anything constructive, but <code>X</code> and <code>Y</code> simply refuse to accept the command when trying to put into them a value not in the range of 0..65279. <br> Why not 0..65535, as someone suggested on the Internets, thinking that this is a 16-bit variable? <br> Well, that's... Because!<h3 id=compiling-everything-into-home-assistant>Compiling everything into Home Assistant</h3><p>As a result, we have gathered all the knowledge gained during the poking thing with a stick, and we are ready to write the function.<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>tz3210_lamp </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> id: name: short_addr: gw_addr:
</span><span>  {
</span><span>    </span><span style=color:#d08770>unique_id </span><span>= </span><span style=color:#bf616a>id</span><span>;
</span><span>    </span><span style=color:#d08770>name </span><span>= </span><span style=color:#bf616a>name</span><span>;
</span><span>    </span><span style=color:#d08770>command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>payload_on </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": {"Power": "ON"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>payload_off </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": {"Power": "OFF"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>brightness_command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>brightness_command_template </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": { "Dimmer": "{{ value - 1 }}" }}</span><span>'';
</span><span>    </span><span style=color:#d08770>brightness_state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>brightness_value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].Dimmer }}</span><span>";
</span><span>    </span><span style=color:#d08770>xy_command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>xy_command_template </span><span>= ''</span><span style=color:#a3be8c>{"Device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send":{ "Color": "{{ x * 65279 }},{{ y * 65279 }}"}}</span><span>'';
</span><span>    </span><span style=color:#d08770>xy_state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>xy_value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].X / 65279 }},{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].Y / 65279 }}</span><span>";
</span><span>    </span><span style=color:#d08770>color_temp_command_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/ZbSend</span><span>";
</span><span>    </span><span style=color:#d08770>color_temp_command_template </span><span>= ''</span><span style=color:#a3be8c>{"device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send": { "CT": "{{ value - 1 }}" }}</span><span>'';
</span><span>    </span><span style=color:#d08770>color_temp_state_topic </span><span>= "</span><span style=color:#a3be8c>tasmota/tele/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/SENSOR</span><span>";
</span><span>    </span><span style=color:#d08770>color_temp_value_template </span><span>= "</span><span style=color:#a3be8c>{{ value_json.ZbReceived['</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>'].CT }}</span><span>";
</span><span>    </span><span style=color:#d08770>device </span><span>= {
</span><span>      </span><span style=color:#d08770>name </span><span>= "</span><span style=color:#a3be8c>RGB Lamp</span><span>";
</span><span>      </span><span style=color:#d08770>model </span><span>= "</span><span style=color:#a3be8c>TZ3210</span><span>";
</span><span>      </span><span style=color:#d08770>manufacturer </span><span>= "</span><span style=color:#a3be8c>Tuya</span><span>";
</span><span>        </span><span style=color:#d08770>identifiers </span><span>= [ </span><span style=color:#bf616a>short_addr </span><span>];
</span><span>    };
</span><span>  }
</span></code></pre><p>This function is just a beautiful collection of hacks to make the things somehow work. <br> Let's go in order<p>According to Home Assistant, <code>Dimmer</code> should take values 0...255, but as we already know, the maximum value there is 254, so just subtract one. Anyway you can't lower power in HA interface lower than 3%. Same thing for <code>CT</code>.<p>According to the same Home Assistant, <code>X</code> and <code>Y</code> take values from 0 to 1.0, so the conversion back and forth is done simply by multiplication by the maximum possible value.<p>Besides, <code>Color</code> function is used here in <code>xy_command_template</code>, which allows to pass <code>X</code> and <code>Y</code> values in one command, which was accidentally found in the discussion about some device I don't remember where.<p>If this function wasn't there, the config would look something like this:<pre class=language-nix data-lang=nix style=color:#c0c5ce;background-color:#2b303b><code class=language-nix data-lang=nix><span style=color:#bf616a>xy_command_topic </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> "</span><span style=color:#a3be8c>tasmota/cmnd/tasmota_</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>gw_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>/Backlog</span><span>"</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span><span style=color:#bf616a>xy_command_template </span><span style=color:#2b303b;background-color:#bf616a>=</span><span> ''</span><span style=color:#a3be8c>ZbSend {"Device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send":{ "X": "{{ x * 65279 }}"}}; ZbSend {"Device": "</span><span style=color:#ab7967;font-style:italic>${</span><span style=color:#bf616a;font-style:italic>short_addr</span><span style=color:#ab7967;font-style:italic>}</span><span style=color:#a3be8c>", "send":{ "Y": "{{ y * 65279 }}"}}</span><span>''</span><span style=color:#2b303b;background-color:#bf616a>;</span><span>
</span></code></pre><h1 id=this-is-the-end>This is the end</h1><p>And on that note, my adventures are finally over.<p>The lights are lighting, the boiler is boiling and even the aquarium light has its own remote control.<p>I really didn't like the smart home, the process was just too stupid for production use.<p>And the fucked up overpricings upset me even more. <br> I'd better go to AliExpress to buy other hardware, at least there they can clearly write the model and manufacturer.<figure class=center><img decoding=async loading=lazy src=/blog/tasmota-tuya-perversions/bisexual-lighting.png><figcaption class=center><p>Fig. 7. Bisexual lighting</p></figcaption></figure></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Evgenia Vaartis</span><span class=copyright-theme> <span class=copyright-theme-sep>:: </span> Theme: <a href=https://github.com/pawroman/zola-theme-terminimal/>Terminimal</a> by pawroman </span></div></div></footer></div>